#include <iostream>
#include <filesystem>
#include <fstream>
#include <string>
#include <vector>
#include <iomanip>
#include <sstream>

namespace fs = std::filesystem;
using namespace std;

// Function to list all files and directories
void listDirectory(const fs::path& path = fs::current_path()) {
    cout << "\nðŸ“‚ Listing directory: \"" << path << "\"\n";
    cout << "-------------------------------------------------------------\n";
    cout << left << setw(30) << "Name" << setw(12) << "Type" << "Size(bytes)\n";
    cout << "-------------------------------------------------------------\n";

    try {
        for (const auto& entry : fs::directory_iterator(path)) {
            string type = entry.is_directory() ? "Directory" : "File";
            auto size = entry.is_directory() ? 0 : fs::file_size(entry);
            cout << left << setw(30) << entry.path().filename().string()
                 << setw(12) << type << size << "\n";
        }
    } catch (const exception& e) {
        cerr << "âŒ Error: " << e.what() << "\n";
    }
}

// Function to change current directory
void changeDirectory(const string& dir) {
    try {
        fs::current_path(dir);
        cout << "âœ… Changed directory to: " << fs::current_path() << "\n";
    } catch (const exception& e) {
        cerr << "âŒ Error: " << e.what() << "\n";
    }
}

// Function to copy files
void copyFile(const string& src, const string& dest) {
    try {
        fs::copy(src, dest, fs::copy_options::overwrite_existing);
        cout << "ðŸ“„ File copied successfully.\n";
    } catch (const exception& e) {
        cerr << "âŒ Error copying file: " << e.what() << "\n";
    }
}

// Function to move (rename) files
void moveFile(const string& src, const string& dest) {
    try {
        fs::rename(src, dest);
        cout << "ðŸ“¦ File moved successfully.\n";
    } catch (const exception& e) {
        cerr << "âŒ Error moving file: " << e.what() << "\n";
    }
}

// Function to delete files
void deleteFile(const string& filename) {
    try {
        if (fs::remove(filename))
            cout << "ðŸ—‘ï¸ File deleted successfully.\n";
        else
            cout << "âš ï¸ File not found.\n";
    } catch (const exception& e) {
        cerr << "âŒ Error deleting file: " << e.what() << "\n";
    }
}

// Function to create directory
void createDirectory(const string& foldername) {
    try {
        if (fs::create_directory(foldername))
            cout << "ðŸ“ Directory created: " << foldername << "\n";
        else
            cout << "âš ï¸ Directory already exists.\n";
    } catch (const exception& e) {
        cerr << "âŒ Error: " << e.what() << "\n";
    }
}

// Function to create an empty file
void createFile(const string& filename) {
    ofstream file(filename);
    if (file) {
        cout << "ðŸ“„ File created: " << filename << "\n";
        file.close();
    } else {
        cerr << "âŒ Could not create file.\n";
    }
}

// Recursive file search
void searchFile(const fs::path& path, const string& target, vector<fs::path>& results) {
    for (const auto& entry : fs::directory_iterator(path)) {
        if (entry.is_directory()) {
            searchFile(entry.path(), target, results);
        } else if (entry.path().filename() == target) {
            results.push_back(entry.path());
        }
    }
}

void searchCommand(const string& filename) {
    vector<fs::path> results;
    cout << "ðŸ” Searching for \"" << filename << "\"...\n";
    searchFile(fs::current_path(), filename, results);

    if (results.empty()) {
        cout << "âŒ File not found.\n";
    } else {
        cout << "âœ… Found " << results.size() << " match(es):\n";
        for (auto& p : results)
            cout << "  " << p << "\n";
    }
}

// Function to view file permissions
void viewPermissions(const string& filename) {
    try {
        fs::perms p = fs::status(filename).permissions();
        cout << "ðŸ” Permissions for " << filename << ": ";
        cout << ((p & fs::perms::owner_read) != fs::perms::none ? "r" : "-");
        cout << ((p & fs::perms::owner_write) != fs::perms::none ? "w" : "-");
        cout << ((p & fs::perms::owner_exec) != fs::perms::none ? "x" : "-");
        cout << ((p & fs::perms::group_read) != fs::perms::none ? "r" : "-");
        cout << ((p & fs::perms::group_write) != fs::perms::none ? "w" : "-");
        cout << ((p & fs::perms::group_exec) != fs::perms::none ? "x" : "-");
        cout << ((p & fs::perms::others_read) != fs::perms::none ? "r" : "-");
        cout << ((p & fs::perms::others_write) != fs::perms::none ? "w" : "-");
        cout << ((p & fs::perms::others_exec) != fs::perms::none ? "x" : "-");
        cout << "\n";
    } catch (const exception& e) {
        cerr << "âŒ Error: " << e.what() << "\n";
    }
}

// Function to change permissions
void changePermissions(const string& filename, const string& permstr) {
    try {
        fs::perms perms = static_cast<fs::perms>(stoul(permstr, nullptr, 8));
        fs::permissions(filename, perms);
        cout << "âœ… Permissions updated for " << filename << "\n";
    } catch (const exception& e) {
        cerr << "âŒ Error changing permissions: " << e.what() << "\n";
    }
}

int main() {
    cout << "=============================\n";
    cout << "ðŸ§­ Linux File Explorer (C++)\n";
    cout << "=============================\n";
    cout << "Type 'help' to see available commands.\n\n";

    string command;
    while (true) {
        cout << "\n[" << fs::current_path() << "]$ ";
        getline(cin, command);
        stringstream ss(command);
        string cmd, arg1, arg2;
        ss >> cmd >> arg1 >> arg2;

        if (cmd == "exit") break;
        else if (cmd == "help") {
            cout << "\nðŸ“˜ Available commands:\n";
            cout << "  ls                       â†’ List directory contents\n";
            cout << "  cd <dir>                 â†’ Change directory\n";
            cout << "  cp <src> <dest>          â†’ Copy file\n";
            cout << "  mv <src> <dest>          â†’ Move/Rename file\n";
            cout << "  rm <file>                â†’ Delete file\n";
            cout << "  mkdir <folder>           â†’ Create folder\n";
            cout << "  touch <file>             â†’ Create empty file\n";
            cout << "  search <filename>        â†’ Search file recursively\n";
            cout << "  viewperm <file>          â†’ View file permissions\n";
            cout << "  chmod <octal> <file>     â†’ Change file permissions (e.g., chmod 755 file)\n";
            cout << "  exit                     â†’ Exit program\n";
        }
        else if (cmd == "ls") listDirectory();
        else if (cmd == "cd") changeDirectory(arg1);
        else if (cmd == "cp") copyFile(arg1, arg2);
        else if (cmd == "mv") moveFile(arg1, arg2);
        else if (cmd == "rm") deleteFile(arg1);
        else if (cmd == "mkdir") createDirectory(arg1);
        else if (cmd == "touch") createFile(arg1);
        else if (cmd == "search") searchCommand(arg1);
        else if (cmd == "viewperm") viewPermissions(arg1);
        else if (cmd == "chmod") changePermissions(arg2, arg1);
        else if (cmd.empty()) continue;
        else cout << "âš ï¸ Unknown command. Type 'help' for a list of commands.\n";
    }

    cout << "\nðŸ‘‹ Exiting File Explorer. Goodbye!\n";
    return 0;
}
